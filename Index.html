<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Leaflet JS</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <style>
            html, body {
                margin: 0;
            }

            #map {
                width: 100%;
                height: 100vh;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script>
            // Inisialisasi peta
            var map = L.map("map").setView([-8.4019176,122.9583038], 10);

            // Tile Layer Base Map
            var basemap = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            });

            // Menambahkan basemap ke dalam peta
            basemap.addTo(map);


            // Memanggil data GeoJSON dari file Topomimi
            // Define layer groups
            let Topomimi = L.layerGroup();
            fetch('BahanOutput/Topomimi.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, {
                            icon: L.icon({
                                iconUrl: "img/home_marker.png", // icon marker
                                iconSize: [32, 32], // ukuran icon
                                iconAnchor: [16, 32], // posisi icon terhadap titik (point)
                                popupAnchor: [0, -32], // posisi popup terhadap icon
                                tooltipAnchor: [10, -20] // posisi tooltip terhadap icon
                            }),
                        });
                    },
                    onEachFeature: function (feature, layer) {
                        // variable popup content
                        var popup_content = "Nama: " + feature.properties.TOPONIMI + "<br>" +
                        "Koordinat: " + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0];
                        
                        // Add popup
                        layer.bindPopup(popup_content);

                        // Add tooltip
                        layer.bindTooltip(feature.properties.TOPONIMI, {
                            permanent: false,
                            direction: "right",
                        });
                    }
                }).addTo(Topomimi);
            });

            Topomimi.addTo(map);

            // --- START OF NEW JALAN LAYER ---
            // GeoJSON Polyline Jalan
            var jalan_new = L.geoJSON(null, {
                // Style
                style: function (feature) {
                    return {
                        color: "Green",
                        opacity: 1,
                        weight: 2,
                    };
                },

                // onEachFeature
                onEachFeature: function (feature, layer) {
                    // Popup content
                    var popup_content = "Fungsi: " + feature.properties.fungsi + "<br>" +
                        "Panjang (m): " + feature.properties.panjang_m;

                    // Bind popup directly
                    layer.bindPopup(popup_content);

                    // Bind tooltip on hover
                    layer.bindTooltip(feature.properties.fungsi, {
                        direction: "auto",
                        sticky: true,
                    });
                },
            });

            // Load the GeoJSON file
            $.getJSON("BahanOutput/Jwawan.geojson", function (Output) {
                jalan_new.addData(Output); // Add data to GeoJSON layer
                map.addLayer(jalan_new);   // Add to map
            });
            // --- END OF NEW JALAN LAYER ---


            // GeoJSON Polygon Sungai
            let sungai = L.layerGroup();
            fetch("BahanOutput/Swungawi.geojson")
                .then(response => response.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: function (feature) {
                            return {
                                color: "blue",
                                fillColor: "cyan",
                                fillOpacity: 0.5,
                                weight: 1,
                            };
                        },
                    }).addTo(sungai);
                });

            sungai.addTo(map);

            // --- START OF NEW POPULATION LAYER ---
            // GeoJSON Polygon Jumlah Penduduk
            map.createPane('panejumlahpenduduk');
            map.getPane("panejumlahpenduduk").style.zIndex = 301; // Sets draw order
            var batas_kec = L.geoJSON(null, {
                pane: 'panejumlahpenduduk', // Assign to the custom pane
                style: function (feature) {
                    if (feature.properties.Penduduk <= 15000) {
                        return {
                            opacity: 1,
                            color: 'black',
                            weight: 1.0,
                            fillOpacity: 0.7,
                            fillColor: '#ffffb2'
                        };
                    }
                    if (feature.properties.Penduduk > 15000 && feature.properties.Penduduk <= 30000) {
                        return {
                            opacity: 1,
                            color: 'black',
                            weight: 1.0,
                            fillOpacity: 0.7,
                            fillColor: '#fd8d3c'
                        };
                    }
                    if (feature.properties.Penduduk > 30000) {
                        return {
                            opacity: 1,
                            color: 'black',
                            weight: 1.0,
                            fillOpacity: 0.7,
                            fillColor: '#bd0026'
                        };
                    }
                },

                onEachFeature: function (feature, layer) {
                    // Popup content
                    var popup_content = "Kecamatan: " + feature.properties.kecamatan + "<br>" +
                        "Jumlah Penduduk: " + feature.properties.Penduduk;

                    // Bind popup to the polygon
                    layer.bindPopup(popup_content);

                    // Tooltip (optional)
                    layer.bindTooltip(feature.properties.kecamatan, {
                        direction: "auto",
                        sticky: true,
                    });
                }
            });

            // Load the GeoJSON file
            $.getJSON("BahanOutput/Bwatas_Kwecamwatan.geojson", function (Output) {
                batas_kec.addData(Output);  // Add data to the polygon layer
                map.addLayer(batas_kec);    // Add polygon layer to the map
            });
            // --- END OF NEW POPULATION LAYER ---

            // --- UPDATED CONTROL LAYER ---
            var baseMaps = {
                "OpenStreetMap": basemap
            };

            // Updated to use the new layer variables: jalan_new and batas_kec
            var overlayMaps = {
                "Toponimi": Topomimi,
                "Jalan": jalan_new, // Changed from 'jalan'
                "Sungai": sungai,
                "Jumlah Penduduk": batas_kec // Changed from 'jumlah_penduduk'
            };

            // Add the corrected layer control to the map
            L.control.layers(baseMaps, overlayMaps).addTo(map);

        </script>
    </body>
</html>